<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Drill Beats</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- Styles (Condensed with new additions) --- */
        html{font-size:90%}body{margin:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background-color:#121212;color:#e0e0e0}.background-container{width:90%;max-width:1100px;margin:30px auto;background-color:#1e1e1e;background-image:url(images/background.jpg);background-size:cover;background-position:center;border-radius:15px;box-shadow:0 0 20px rgba(0,0,0,.5);padding:20px 40px}.header{display:flex;justify-content:space-between;align-items:center;padding-bottom:20px;border-bottom:1px solid #333}.header h1{color:#e53935;margin:0;font-size:1.8em;text-transform:uppercase;letter-spacing:1px}.login-signup-area a{color:#e0e0e0;text-decoration:none;margin-left:15px;padding:8px 15px;border:1px solid #e53935;border-radius:5px;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.3)}.login-signup-area a:hover{background-color:#e53935;color:#fff;box-shadow:0 4px 8px rgba(0,0,0,.5)}#user-status{display:none;align-items:center;gap:15px}#user-status span{font-weight:700}h2{color:#e53935;border-bottom:2px solid #e53935;padding-bottom:10px;margin-top:30px}.featured-beats-list{min-height:100px;display:flex;gap:20px;padding:15px;flex-wrap:wrap;justify-content:center}.featured-beat-item{flex-shrink:0;width:220px;background-color:#2c2c2c;padding:15px;border-radius:10px;text-align:center;border:1px solid #e53935;box-shadow:0 4px 8px rgba(0,0,0,0.4)}.featured-beat-item .song-name{font-weight:700;font-size:1.1em;margin-bottom:10px;display:block}.beat-list{min-height:100px;display:flex;flex-direction:column;gap:15px}.beat-item{display:grid;grid-template-columns:1fr auto auto auto auto;align-items:center;background-color:#2c2c2c;padding:15px;border-radius:10px;transition:background-color .3s}.beat-item:hover{background-color:#383838}.beat-item.sold-out{text-decoration:line-through;opacity:0.6;}.beat-item .song-name{font-size:1.2em;font-weight:700;text-align:left}.beat-item .button,.featured-beat-item .button{background:0 0;border:none;color:#e0e0e0;cursor:pointer;font-size:24px;margin:0 5px;padding:5px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:color .3s}.beat-item .button:hover,.featured-beat-item .button:hover{color:#e53935}.buy-lease-button{background-color:#e53935;color:#fff;padding:8px 20px;border-radius:5px;text-decoration:none;font-weight:700;font-size:16px;margin-left:10px;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.3); border: none; cursor: pointer;}.buy-lease-button:hover{background-color:#c42724;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.5)}.like-container{display:flex;align-items:center;gap:5px;min-width:60px}.like-button.liked .material-icons{color:#e53935}.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:1000}.modal-content{background:#2c2c2c;padding:30px;border-radius:10px;width:90%;max-width:550px;box-shadow:0 5px 15px rgba(0,0,0,.5);position:relative}.modal-close{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#fff;cursor:pointer}.modal-content h3{color:#e53935;text-align:center;margin-top:0}.auth-form{display:flex;flex-direction:column;gap:15px}.auth-form input{background:#1e1e1e;border:1px solid #555;border-radius:5px;padding:12px;color:#fff;font-size:16px}.auth-form input:focus{outline:0;border-color:#e53935}.form-buttons{display:flex;gap:10px;justify-content:center;margin-top:10px}.form-buttons button{flex:1;padding:12px;border:none;border-radius:5px;font-size:16px;font-weight:700;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.3)}.form-buttons button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.5)}#signup-action-btn{background-color:#e53935;color:#fff}#signup-action-btn:hover{background-color:#c42724}#login-action-btn{background-color:#555;color:#fff}#login-action-btn:hover{background-color:#777}#auth-error{color:#ff8a80;text-align:center;margin-top:15px;font-weight:700;display:none}.auth-separator{text-align:center;color:#888;margin:15px 0}#google-btn{display:flex;align-items:center;justify-content:center;gap:10px;background:#222;color:#fff;border:1px solid #555;width:100%}#google-btn:hover{background:#333}
        /* --- CHANGE: Polished Lease Modal Styles --- */
        .lease-options{display:grid;gap:15px;margin-top:20px;}.lease-option{display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;align-items:center;background:#1e1e1e;padding:15px 20px;border-radius:8px;border:1px solid #e53935; /* Red border for all */}.lease-option.exclusive{position:relative;box-shadow:0 0 15px rgba(229,57,53,0.5); /* Red glow for exclusive */}
        .lease-info{grid-column:1 / 2;}.lease-info h4{margin:0;font-size:1.2em;}.lease-info p{margin:5px 0 0;color:#aaa;font-size:0.9em;}
        .lease-price{grid-column:2 / 3;grid-row:1 / 3;background:#2f2f2f;padding:15px;border-radius:8px;text-align:center;}.lease-price .price{font-size:1.6em;font-weight:bold;margin:0;}.lease-price .buy-now-btn{background:#e53935;color:#fff;padding:8px 15px;margin-top:10px;border-radius:5px;border:none;cursor:pointer;font-weight:bold;transition:background .3s;}.lease-price .buy-now-btn:hover{background:#c42724;}
        /* --- CHANGE: New Share Modal Styles --- */
        .share-modal-content{text-align:center;}.share-modal-content h3{margin-bottom:25px;}.share-links{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;}.share-link{display:flex;flex-direction:column;align-items:center;text-decoration:none;color:#fff;}.share-link .material-icons{font-size:48px;transition:transform .2s;}.share-link:hover .material-icons{transform:scale(1.1);color:#e53935;}.share-link span{margin-top:5px;}
    </style>
</head>
<body>
    <div class="background-container"><header class="header"><h1>UK Drill Beats</h1><div class="login-signup-area"><div id="logged-out-view"><a id="login-btn">Log In</a><a id="signup-btn">Sign Up</a></div><div id="user-status"><span id="user-email"></span><a id="logout-btn">Log Out</a></div></div></header><main><section class="featured-beats"><h2>Featured Beats</h2><div class="featured-beats-list" id="featured-beats-list"></div></section><section class="all-beats"><h2>All Beats</h2><div class="beat-list" id="all-beats-list"></div></section></main></div>
    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal"><div class="modal-content"><span class="modal-close" id="modal-close-btn-auth">&times;</span><h3 id="modal-title">Welcome</h3><form class="auth-form" onsubmit="return false;"><input type="email" id="auth-email" placeholder="Email" required><input type="password" id="auth-password" placeholder="Password (min. 6 characters)" required><div class="form-buttons"><button type="button" id="login-action-btn">Log In</button><button type="button" id="signup-action-btn">Sign Up</button></div><p id="auth-error"></p><div class="auth-separator">or</div><button type="button" id="google-btn" class="form-buttons"><span class="material-icons">login</span>Continue with Google</button></form></div></div>
    <!-- Lease Modal -->
    <div class="modal-overlay" id="lease-modal"><div class="modal-content"><span class="modal-close" id="modal-close-btn-lease">&times;</span><h3 id="lease-title">Purchase Lease</h3><div id="lease-options-container" class="lease-options"></div></div></div>
    <!-- NEW: Share Modal -->
    <div class="modal-overlay" id="share-modal"><div class="modal-content share-modal-content"><span class="modal-close" id="modal-close-btn-share">&times;</span><h3 id="share-title">Share Beat</h3><div id="share-links-container" class="share-links"></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, increment, collection, query, where, getDocs, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        
        const firebaseConfig={apiKey:"AIzaSyCkXeTXEZ-VpAAKr5aMY3iTuZCW330aMUQ",authDomain:"dream-hive-uk-drill-beats.firebaseapp.com",projectId:"dream-hive-uk-drill-beats",storageBucket:"dream-hive-uk-drill-beats.appspot.com",messagingSenderId:"817848550593",appId:"1:817848550593:web:7dbadc392729127c8d4040",measurementId:"G-HPKZYPMX3G"};
        const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
        let currentUser=null,userLikes=new Map(),allBeatsData=[],featuredBeatsData=[],currentAudio=null,currentPlayButton=null,stopTimer=null;
        
        // --- Modal Logic ---
        const leaseModal = document.getElementById('lease-modal');
        const shareModal = document.getElementById('share-modal');
        function showLeaseModal(beat){if(beat.isSold)return;document.getElementById('lease-title').textContent=`Purchase: ${beat.songName}`;const container=document.getElementById('lease-options-container');container.innerHTML=`<div class="lease-option"><div class="lease-info"><h4>MP3 Lease</h4><p>High-quality MP3 file.</p></div><div class="lease-price"><p class="price">$29.99</p><button class="buy-now-btn" data-type="mp3">Buy Now</button></div></div><div class="lease-option"><div class="lease-info"><h4>WAV Lease</h4><p>Uncompressed WAV file.</p></div><div class="lease-price"><p class="price">$49.99</p><button class="buy-now-btn" data-type="wav">Buy Now</button></div></div><div class="lease-option exclusive"><div class="lease-info"><h4>Exclusive Rights</h4><p>The beat is yours, removed from the store forever.</p></div><div class="lease-price"><p class="price">$299.99</p><button class="buy-now-btn" data-type="exclusive">Buy Now</button></div></div>`;leaseModal.style.display="flex"}
        
        // --- NEW/REWORKED SHARE LOGIC ---
        function showShareModal(beatId, songName) {
            document.getElementById('share-title').textContent = `Share: ${songName}`;
            const url = new URL(window.location.href);
            url.searchParams.set('beat', beatId);
            const encodedUrl = encodeURIComponent(url.toString());
            const text = encodeURIComponent(`Check out this beat: ${songName}`);
            
            const links = [
                { name: 'Copy Link', icon: 'link', action: () => { navigator.clipboard.writeText(url.toString()); alert('Link Copied!'); shareModal.style.display = "none"; } },
                { name: 'Twitter', icon: 'share', url: `https://twitter.com/intent/tweet?url=${encodedUrl}&text=${text}` },
                { name: 'Facebook', icon: 'share', url: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}` },
                { name: 'WhatsApp', icon: 'share', url: `https://api.whatsapp.com/send?text=${text}%20${encodedUrl}` }
            ];

            const container = document.getElementById('share-links-container');
            container.innerHTML = links.map(link => 
                link.url ? `<a href="${link.url}" target="_blank" class="share-link"><i class="material-icons">${link.icon}</i><span>${link.name}</span></a>`
                         : `<a href="#" class="share-link" id="copy-link-btn"><i class="material-icons">${link.icon}</i><span>${link.name}</span></a>`
            ).join('');
            
            document.getElementById('copy-link-btn')?.addEventListener('click', (e) => { e.preventDefault(); links[0].action(); });
            shareModal.style.display = "flex";
        }

        // --- Core Logic (Auth, Likes, Player) ---
        onAuthStateChanged(auth,async user=>{currentUser=user;if(user){document.getElementById("user-email").textContent=user.email,document.getElementById("user-status").style.display="flex",document.getElementById("logged-out-view").style.display="none",document.getElementById("auth-modal").style.display="none",await fetchUserLikes()}else document.getElementById("user-status").style.display="none",document.getElementById("logged-out-view").style.display="flex",userLikes.clear();renderAllBeats()});
        async function fetchUserLikes(){if(!currentUser)return;const q=query(collection(db,"likes"),where("userId","==",currentUser.uid)),querySnapshot=await getDocs(q);userLikes=new Map(querySnapshot.docs.map(doc=>[doc.data().beatId,doc.id]))}
        function playPreview(button,filePath){const icon=button.querySelector(".material-icons");if(currentPlayButton===button){currentAudio.pause();return}if(currentAudio)currentAudio.pause();currentAudio=new Audio(filePath),currentAudio.play(),icon.textContent="stop",currentPlayButton=button,stopTimer=setTimeout(()=>{if(currentPlayButton===button)currentAudio.pause()},30e3);const stopHandler=()=>{icon.textContent="play_arrow",currentPlayButton===button&&(currentPlayButton=null),clearTimeout(stopTimer)};currentAudio.addEventListener("pause",()=>{stopHandler(),currentAudio.currentTime=0}),currentAudio.addEventListener("ended",stopHandler)}
        async function handleLike(beatId){if(!currentUser)return void alert("Please log in to like beats!");const beatRef=doc(db,"beats",beatId),batch=writeBatch(db),hasLiked=userLikes.has(beatId);if(hasLiked){const likeDocId=userLikes.get(beatId),likeRef=doc(db,"likes",likeDocId);batch.delete(likeRef),batch.set(beatRef,{likeCount:increment(-1)},{merge:!0}),await batch.commit(),userLikes.delete(beatId)}else{const likeRef=doc(collection(db,"likes"));batch.set(beatRef,{likeCount:increment(1)},{merge:!0}),batch.set(likeRef,{userId:currentUser.uid,beatId:beatId}),await batch.commit(),userLikes.set(beatId,likeRef.id)}const beatToUpdate=allBeatsData.find(b=>b.id===beatId);beatToUpdate&&(beatToUpdate.likeCount=(beatToUpdate.likeCount||0)+(hasLiked?-1:1)),renderAllBeats()}
        
        // --- HTML Rendering ---
        function createBeatItemHTML(beat){const isLiked=userLikes.has(beat.id);const soldClass=beat.isSold?"sold-out":"";return`<div class="beat-item ${soldClass}" data-beat-id="${beat.id}"><span class=song-name>${beat.songName}</span><button class="button play-button"><i class=material-icons>play_arrow</i></button><div class=like-container><button class="button like-button ${isLiked?"liked":""}"><i class=material-icons>favorite</i></button><span class=like-count>${beat.likeCount||0}</span></div><button class="button share-button"><i class=material-icons>share</i></button>${beat.isSold?`<span class="buy-lease-button" style="background: #555; cursor: default;">SOLD</span>`:`<button class="buy-lease-button">BUY LEASE</button>`}</div>`}
        function createFeaturedBeatHTML(beat){return`<div class=featured-beat-item data-beat-id=${beat.id}><span class=song-name>${beat.songName}</span><button class="button play-button"><i class=material-icons style=font-size:48px>play_arrow</i></button></div>`}
        function renderAllBeats(){document.getElementById("featured-beats-list").innerHTML=featuredBeatsData.map(createFeaturedBeatHTML).join(""),document.getElementById("all-beats-list").innerHTML=allBeatsData.map(createBeatItemHTML).join("")}
        
        // --- Page Initialization & Event Listeners ---
        async function init(){try{const response=await fetch("beat-list.json?cachebust="+new Date().getTime());if(!response.ok)throw new Error("Could not fetch beat-list.json");const fileData=await response.json();allBeatsData=fileData.allBeats.map(b=>({...b,id:b.songName.replace(/\s+/g,"-").toLowerCase()})).reverse(),featuredBeatsData=fileData.featuredBeats.map(b=>({...b,id:b.songName.replace(/\s+/g,"-").toLowerCase()})).reverse();const dataPromises=allBeatsData.map(async beat=>{const docRef=doc(db,"beats",beat.id),docSnap=await getDoc(docRef);if(docSnap.exists()){beat.likeCount=docSnap.data().likeCount||0;beat.isSold=docSnap.data().isSold||!1}return beat});allBeatsData=await Promise.all(dataPromises);renderAllBeats();const urlParams=new URLSearchParams(window.location.search);const deepLinkedBeatId=urlParams.get("beat");if(deepLinkedBeatId){const beatToShow=allBeatsData.find(b=>b.id===deepLinkedBeatId);if(beatToShow)showLeaseModal(beatToShow)}}catch(e){console.error("Error loading beats:",e),document.getElementById("all-beats-list").innerHTML='<p style="text-align:center;padding:20px;">Could not load beats. Wait a moment and refresh.</p>'}}
        
        document.addEventListener("DOMContentLoaded",()=>{
            init();
            // Auth modal listeners...
            const authModal=document.getElementById("auth-modal");document.getElementById("login-btn").addEventListener("click",()=>authModal.style.display="flex"),document.getElementById("signup-btn").addEventListener("click",()=>authModal.style.display="flex"),document.getElementById("modal-close-btn-auth").addEventListener("click",()=>{authModal.style.display="none",document.getElementById("auth-error").style.display="none"}),document.getElementById("logout-btn").addEventListener("click",()=>signOut(auth));const emailInput=document.getElementById("auth-email"),passwordInput=document.getElementById("auth-password");document.getElementById("signup-action-btn").addEventListener("click",async()=>{try{await createUserWithEmailAndPassword(auth,emailInput.value,passwordInput.value)}catch(e){document.getElementById("auth-error").textContent=e.message,document.getElementById("auth-error").style.display="block"}}),document.getElementById("login-action-btn").addEventListener("click",async()=>{try{await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value)}catch(e){document.getElementById("auth-error").textContent="auth/invalid-credential"===e.code?"In a rush? Sign up first, silly.":e.message,document.getElementById("auth-error").style.display="block"}});const googleProvider=new GoogleAuthProvider;googleProvider.setCustomParameters({prompt:"select_account"});const isIOS=/iPhone|iPad|iPod/.test(navigator.userAgent);async function signInWithGoogle(){try{isIOS?await signInWithRedirect(auth,googleProvider):await signInWithPopup(auth,googleProvider)}catch(e){if("auth/popup-blocked"===e.code||"auth/popup-closed-by-user"===e.code)return void await signInWithRedirect(auth,googleProvider);document.getElementById("auth-error").textContent=e.message,document.getElementById("auth-error").style.display="block"}}getRedirectResult(auth).catch(()=>{});document.getElementById("google-btn").addEventListener("click",signInWithGoogle);
            
            // Close Modals
            document.getElementById('modal-close-btn-lease').addEventListener('click', () => leaseModal.style.display = "none");
            document.getElementById('modal-close-btn-share').addEventListener('click', () => shareModal.style.display = "none");

            // Master Event Delegation
            const handleInteraction=(e,listData)=>{const playButton=e.target.closest(".play-button"),likeButton=e.target.closest(".like-button"),shareButton=e.target.closest(".share-button"),buyLeaseButton=e.target.closest(".buy-lease-button"),beatItem=e.target.closest("[data-beat-id]");if(!beatItem)return;const beatId=beatItem.dataset.beatId,beat=listData.find(b=>b.id===beatId);if(!beat)return;if(playButton)playPreview(playButton,beat.filePath);if(likeButton)handleLike(beat.id);if(shareButton)showShareModal(beat.id,beat.songName);if(buyLeaseButton)showLeaseModal(beat)};
            document.getElementById("all-beats-list").addEventListener("click",e=>handleInteraction(e,allBeatsData)),document.getElementById("featured-beats-list").addEventListener("click",e=>handleInteraction(e,featuredBeatsData));
        });
    </script>
</body>
</html>